<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Donut Shop Equilibrium Game</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    canvas { max-width: 100%; }
    #hint, #status, #score { font-weight: bold; margin-top: 10px; }
    #main-container { display: flex; align-items: flex-start; gap: 30px; margin-top: 20px; }
    #debug-panel {
      border: 1px solid #ccc;
      padding: 10px;
      width: 400px;
      white-space: pre-wrap;
      font-family: monospace;
      align-self: center;
      box-sizing: border-box;
    }
    .modal {
      display: block;
      position: fixed;
      z-index: 999;
      padding-top: 80px;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: auto;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 600px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover { color: #000; }
  </style>
</head>
<body>
  <div id="explanationModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>Welcome to Your Donut Shop!</h2>
      <p>You're a donut shop owner. Each morning, you must decide how many donuts to make.</p>
      <ul>
        <li>Too many? Donuts go to waste. üç©üí∏</li>
        <li>Too few? You miss out on hungry customers. üòü</li>
        <li>Your goal: Match donut supply with customer demand.</li>
        <li>Guess the right amount of donuts in the fewest number of days!</li>
      </ul>
    </div>
  </div>

  <h1>Donut Supply and Demand Challenge</h1>
  <label for="quantity">How many donuts will you make today? </label>
  <input type="number" id="quantity" step="1" min="0" value="0">
  <button onclick="testQuantity()">Bake Donuts</button>
  <p id="status"></p>
  <p id="hint"></p>
  <p id="score"></p>

  <div id="main-container">
    <div>
      <canvas id="gameChart" width="800" height="400"></canvas>
    </div>
    <div id="debug-panel">
      <h3>Debug Panel</h3>
      <label><input type="checkbox" id="toggleSupply" onchange="updateDebugGraph()"> Show Supply Curve</label><br>
      <label><input type="checkbox" id="toggleDemand" onchange="updateDebugGraph()"> Show Demand Curve</label><br>
      <label><input type="checkbox" id="toggleEquilibrium" onchange="updateDebugGraph()"> Show Equilibrium Point</label>
      <p id="debug-info"></p>
    </div>
  </div>

  <h2>Your Daily Results</h2>
  <canvas id="logChart" width="900" height="300"></canvas>

  <script>
    document.getElementById('quantity').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') testQuantity();
    });

    let day = 1;
    let gameOver = false;

    const demandSlope = -Math.random() * 0.1 - 0.05;
    const demandIntercept = Math.random() * 5 + 5;
    const supplySlope = Math.random() * 0.1 + 0.05;
    const supplyIntercept = Math.random() * 2;

    const demandCurve = [];
    const supplyCurve = [];
    let equilibrium = null;

    for (let q = 0; q <= 150; q++) {
      demandCurve.push({ x: q, y: demandSlope * q + demandIntercept });
      supplyCurve.push({ x: q, y: supplySlope * q + supplyIntercept });
    }

    const eqX = (demandIntercept - supplyIntercept) / (supplySlope - demandSlope);
    const eqY = demandSlope * eqX + demandIntercept;
    const optimalQty = Math.floor(eqX + 0.5);
    if (eqX >= 0 && eqY >= 0) equilibrium = { x: eqX, y: eqY };

    document.getElementById("debug-info").innerText =
      `Equilibrium Quantity: ${equilibrium ? '~' + optimalQty : "N/A"}\n` +
      `Demand Curve: price = ${demandSlope.toFixed(3)} * quantity + ${demandIntercept.toFixed(2)}\n` +
      `Supply Curve: price = ${supplySlope.toFixed(3)} * quantity + ${supplyIntercept.toFixed(2)}`;

    const ctx = document.getElementById('gameChart').getContext('2d');
    const gameChart = new Chart(ctx, {
      type: 'scatter',
      data: {
        datasets: [
  {
    label: 'Supply at Your Qty',
    data: [],
    backgroundColor: 'green',
    borderColor: 'green',
    pointRadius: 5,
    showLine: false
  },
  {
    label: 'Demand at Your Qty',
    data: [],
    backgroundColor: 'blue',
    borderColor: 'blue',
    pointRadius: 5,
    showLine: false
  },
  {
    label: 'Supply Curve (full)',
    data: [],
    borderColor: 'lightgreen',
    pointRadius: 0,
    showLine: true,
    borderDash: [5, 5]
  },
  {
    label: 'Demand Curve (full)',
    data: [],
    borderColor: 'lightblue',
    pointRadius: 0,
    showLine: true,
    borderDash: [5, 5]
  },
  {
    label: 'Equilibrium Point',
    data: [],
    backgroundColor: 'gold',
    borderColor: 'gold',
    pointRadius: 10,
    pointStyle: 'star',
    showLine: false
  }
]


      },
      options: {
        responsive: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: (${ctx.raw.x.toFixed(2)}, $${ctx.raw.y.toFixed(2)})`
            }
          }
        },
        scales: {
          x: { title: { display: true, text: 'Quantity (Donuts)' }, min: 0, max: 100 },
          y: { title: { display: true, text: 'Price ($)' }, min: 0, max: 10 }
        }
      }
    });

    const logCtx = document.getElementById('logChart').getContext('2d');
    const logChart = new Chart(logCtx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [
          { label: 'Your Quantity', data: [], backgroundColor: 'orange' },
          { label: 'Optimal Quantity', data: [], backgroundColor: 'blue' }
        ]
      },
      options: {
        scales: {
          x: { title: { display: true, text: 'Day' } },
          y: { title: { display: true, text: 'Quantity' } }
        }
      }
    });

    function calculateDemand(qty) {
      return demandSlope * qty + demandIntercept;
    }

    function updateChartBounds() {
      const allPoints = [];

      gameChart.data.datasets.forEach(dataset => {
        if (dataset.data && dataset.data.length > 0) {
          allPoints.push(...dataset.data);
        }
      });

      if (allPoints.length === 0) {
        gameChart.options.scales.x.min = 0;
        gameChart.options.scales.x.max = 100;
        gameChart.options.scales.y.min = 0;
        gameChart.options.scales.y.max = 10;
        return;
      }

      const allX = allPoints.map(p => p.x);
      const allY = allPoints.map(p => p.y);

      gameChart.options.scales.x.min = Math.max(0, Math.min(...allX) - 5);
      gameChart.options.scales.x.max = Math.max(...allX) + 10;
      gameChart.options.scales.y.min = Math.max(0, Math.min(...allY) - 1);
      gameChart.options.scales.y.max = Math.max(...allY) + 5;
    }

    function testQuantity() {
        if (gameOver) return;

        const qty = Number(document.getElementById('quantity').value);

        if (isNaN(qty) || qty < 0 || !Number.isInteger(qty)) {
            alert("Please enter a valid, non-negative whole number of donuts.");
            return;
        }


        const demandPrice = calculateDemand(qty);
        const supplyPrice = supplySlope * qty + supplyIntercept;

        // Append scatter points for supply & demand
        gameChart.data.datasets[0].data.push({ x: qty, y: supplyPrice }); // green
        gameChart.data.datasets[1].data.push({ x: qty, y: demandPrice }); // blue

        logChart.data.labels.push(`Day ${day}`);
        logChart.data.datasets[0].data.push(qty);
        logChart.data.datasets[1].data.push(optimalQty);

        let hint = "";
        if (qty === optimalQty) {
            hint = `üéØ Perfect! You found the ideal quantity in ${day} day${day > 1 ? 's' : ''}!`;
            gameChart.data.datasets[4].data = [equilibrium];
            gameOver = true;
        } else if (qty > optimalQty) {
            hint = "Too many donuts ‚Äî some went to waste!";
        } else {
            hint = "Too few donuts ‚Äî some customers walked away!";
        }

        document.getElementById('status').innerText = `You baked ${qty} donut(s).`;
        document.getElementById('hint').innerText = hint;

        updateChartBounds();
        gameChart.update();
        logChart.update();
        day++;
    }



    function updateDebugGraph() {
        gameChart.data.datasets[2].data = document.getElementById('toggleSupply').checked ? supplyCurve : [];
        gameChart.data.datasets[3].data = document.getElementById('toggleDemand').checked ? demandCurve : [];
        gameChart.data.datasets[4].data = document.getElementById('toggleEquilibrium').checked && equilibrium ? [equilibrium] : [];
        updateChartBounds();
        gameChart.update();
    }



    function closeModal() {
      document.getElementById('explanationModal').style.display = 'none';
    }
  </script>
</body>
</html>
